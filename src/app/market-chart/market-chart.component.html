<app-navbar></app-navbar>
<div class="container-fluid">
  <div class="row">
    <!-- Graphique -->
    <div class="col-lg-8 col-md-7">
      <div class="chart-container">
        <h2 class="chart-title">Graphique des prix pour {{ selectedSymbol }}</h2>
        <div class="alert alert-info" *ngIf="balance !== undefined">
          Solde du portefeuille : 1,250,200
        </div>
        <select [(ngModel)]="selectedSymbol" (change)="onSymbolChange(selectedSymbol)" class="form-select mb-3">
          <option *ngFor="let symbol of symbols" [value]="symbol">{{ symbol }}</option>
        </select>
        <div class="time-intervals">
          <button (click)="setTimeInterval('1H')">1Min</button>
          <button (click)="setTimeInterval('5H')">5Min</button>
          <button (click)="setTimeInterval('1H')">1H</button>
          <button (click)="setTimeInterval('5H')">5H</button>
          <button (click)="setTimeInterval('1J')">1J</button>
          <button (click)="setTimeInterval('7J')">7J</button>
          <button (click)="setTimeInterval('1Mois')">1 Mois</button>
      </div>
      
        <ngx-charts-line-chart
          [view]="chartOptions.view"
          [scheme]="chartOptions.colorScheme"
          [results]="chartData"
          [animations]="chartOptions.animations"
          [gradient]="chartOptions.gradient"
          [xAxis]="chartOptions.showXAxis"
          [yAxis]="chartOptions.showYAxis"
          [legend]="chartOptions.showLegend"
          [xAxisTickFormatting]="chartOptions.xAxisTickFormatting"
          [yAxisTickFormatting]="chartOptions.yAxisTickFormatting"
          [autoScale]="chartOptions.autoScale"
          [curve]="chartOptions.curve">
        </ngx-charts-line-chart>
         <!-- Sélection de l'indicateur -->
      <div class="mt-4">
        <label for="indicatorSelect" class="form-label">Sélectionnez un indicateur :</label>
        <select [(ngModel)]="selectedIndicator" (change)="onIndicatorChange(selectedIndicator)" class="form-select" id="indicatorSelect">
          <option *ngFor="let indicator of indicators" [value]="indicator">{{ indicator }}</option>
        </select>
      </div>

      <div class="mt-3" *ngIf="selectedIndicator === 'RSI'">
        <h2>Graphique RSI</h2>
        <ngx-charts-line-chart
          [view]="view"
          [scheme]="colorScheme"
          [results]="rsiData"
          [xAxis]="true"
          [yAxis]="true"
          [legend]="false"
          [showXAxisLabel]="true"
          [xAxisLabel]="'Temps'"
          [showYAxisLabel]="true"
          [yAxisLabel]="'RSI'"
          [autoScale]="true">
        </ngx-charts-line-chart>
      </div>

      <div class="mt-3" *ngIf="selectedIndicator === 'MACD'">
        <h2>Graphique MACD</h2>
        <ngx-charts-line-chart
          [view]="view"
          [scheme]="colorScheme"
          [results]="macdData"
          [xAxis]="true"
          [yAxis]="true"
          [legend]="false"
          [showXAxisLabel]="true"
          [xAxisLabel]="'Temps'"
          [showYAxisLabel]="true"
          [yAxisLabel]="'MACD'"
          [autoScale]="true">
        </ngx-charts-line-chart>
      </div>
    </div>
  </div>

  <div class="col-lg-4 col-md-5 mt-5">
    <div class="prediction-container p-4 border rounded shadow">
      <h3 class="text-center mb-4">Prédictions du marché</h3>
  
      <!-- Chargement -->
      <div *ngIf="!prediction && !error" class="loading-section text-center">
        <p class="mb-3">Chargement...</p>
        <div class="progress mb-3">
          <div
            class="progress-bar progress-bar-striped progress-bar-animated"
            role="progressbar"
            [style.width.%]="loadingProgress"
            [attr.aria-valuenow]="loadingProgress"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            {{ loadingProgress }}%
          </div>
        </div>
        <p>Analyse des données en cours...</p>
      </div>
  
      <!-- Résultats -->
      <div *ngIf="prediction" class="prediction-result text-center">
        <h4>Résultat de l'analyse</h4>
        <p><strong>Décision :</strong> {{ prediction.decision }}</p>
        <p><strong>Confiance :</strong> {{ prediction.confidence }}%</p>
        <p><strong>Timestamp :</strong> {{ prediction.timestamp }}</p>
      </div>
  
      <!-- Erreur -->
      <div *ngIf="error" class="error-section text-center text-danger">
        <p>{{ error }}</p>
      </div>
    </div>
  </div>
  
       <!-- Boutons d'action pour afficher/masquer le formulaire -->
<div class="d-flex justify-content-end mt-3">
  <button class="btn btn-success me-2" (click)="openPositionForm('buy')">
    {{ isFormVisible && positionAction === 'buy' ? 'Fermer le formulaire d\'achat' : 'Acheter' }}
  </button>
  <button class="btn btn-danger" (click)="openPositionForm('sell')">
    {{ isFormVisible && positionAction === 'sell' ? 'Fermer le formulaire de vente' : 'Vendre' }}
  </button>
</div>

<!-- Formulaire d'entrée en position -->
<div *ngIf="isFormVisible" class="mt-3">
  <h2>{{ positionAction === 'buy' ? 'Entrer une position d\'achat' : 'Entrer une position de vente' }}</h2>
  <form (ngSubmit)="enterPosition()" #positionForm="ngForm" class="p-4 border rounded shadow">
    <div class="mb-3">
      <label for="symbol" class="form-label">Symbole:</label>
      <input type="text" id="symbol" [(ngModel)]="selectedSymbol" name="symbol" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="quantity" class="form-label">Quantité:</label>
      <input type="number" id="quantity" [(ngModel)]="quantity" name="quantity" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="entryPrice" class="form-label">Prix d'entrée:</label>
      <input type="number" id="entryPrice" [(ngModel)]="entryPrice" name="entryPrice" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="stopLoss" class="form-label">Stop Loss:</label>
      <input type="number" id="stopLoss" [(ngModel)]="stopLoss" name="stopLoss" class="form-control">
    </div>

    <div class="mb-3">
      <label for="takeProfit" class="form-label">Take Profit:</label>
      <input type="number" id="takeProfit" [(ngModel)]="takeProfit" name="takeProfit" class="form-control">
    </div>

    <div class="mb-3">
      <label for="positionType" class="form-label">Type de position:</label>
      <select id="positionType" [(ngModel)]="positionType" name="positionType" class="form-select">
        <option value="buy">Achat</option>
        <option value="sell">Vente</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary w-100" [disabled]="positionForm.invalid">Entrer en Position</button>
  </form>
</div>

    <!-- Ordres d'achat/vente à droite du graphique -->
    <div class="col-lg-4 col-md-5 d-flex align-items-start">
      <div class="order-book">
        <h3>Order Book pour {{ selectedSymbol }}</h3>
        <div class="mb-3">
          <h4>Ordres d'achat</h4>
          <table class="table table-bordered table-hover" *ngIf="buyOrders.length > 0; else noBuyOrders">
            <thead class="thead-dark">
              <tr>
                <th>Prix</th>
                <th>Quantité</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let buyOrder of buyOrders">
                <td>{{ buyOrder.price | currency }}</td>
                <td>{{ buyOrder.quantity }}</td>
              </tr>
            </tbody>
          </table>
          <ng-template #noBuyOrders>
            <p>Aucun ordre d'achat disponible.</p>
          </ng-template>
        </div>

        <div class="mb-3">
          <h4>Ordres de vente</h4>
          <table class="table table-bordered table-hover" *ngIf="sellOrders.length > 0; else noSellOrders">
            <thead class="thead-dark">
              <tr>
                <th>Prix</th>
                <th>Quantité</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let sellOrder of sellOrders">
                <td>{{ sellOrder.price | currency }}</td>
                <td>{{ sellOrder.quantity }}</td>
              </tr>
            </tbody>
          </table>
          <ng-template #noSellOrders>
            <p>Aucun ordre de vente disponible.</p>
          </ng-template>
        </div>
    <!-- Colonne pour la table -->
    <div class="col-lg-4 col-md-5">
      <h3>Positions Actuelles</h3>
      <table class="table table-striped table-bordered table-hover">
        <thead class="thead-dark">
          <tr>
            <th>Symbol</th>
            <th>Quantity</th>
            <th>Entry Price</th>
            <th>Current Value</th>
            <th>Profit/Loss</th>
            <th>Stop Loss</th>
            <th>Take Profit</th>
            <th>Type</th>
            <th>Action</th> 
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let position of positions" [ngClass]="{'table-success': position.profitOrLoss >= 0, 'table-danger': position.profitOrLoss < 0}">
            <td>{{ position.symbol }}</td>
            <td>{{ position.quantity }}</td>
            <td>{{ position.entryPrice | currency }}</td>
            <td>{{ position.currentValue | currency }}</td>
            <td [ngClass]="{'text-success': position.profitOrLoss >= 0, 'text-danger': position.profitOrLoss < 0}">
              {{ position.profitOrLoss | currency }}
            </td>
            <td>{{ position.stopLoss | currency }}</td>
            <td>{{ position.takeProfit | currency }}</td>
            <td>{{ position.positionType }}</td>
            <td>
              <button *ngIf="!position.isClosed" class="btn btn-danger" (click)="closePosition(position.id, position.currentValue)">Sortir</button>
              <span *ngIf="position.isClosed" class="text-muted">Fermée</span>
            </td>
            
          </tr>
        </tbody>
      </table>
    </div>

